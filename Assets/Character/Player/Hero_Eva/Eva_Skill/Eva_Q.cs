// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// Eva_Q.cs - Eva Q 스킬 투사체
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
//
// ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
// │ 개요 (Overview)                                                                                      │
// │                                                                                                       │
// │ 이 파일은 Eva의 Q 스킬로 발사되는 투사체를 구현합니다.                                                │
// │ 직선으로 날아가다 적에게 적중하면 데미지를 주고, E 스킬 연계 시 추가 투사체를 발사합니다.            │
// │                                                                                                       │
// │ 핵심 기술:                                                                                            │
// │ 1. TickTimer - 네트워크 동기화된 생존 시간                                                           │
// │ 2. OnTriggerEnter - 충돌 감지                                                                        │
// │ 3. VFLight 연계 - E 스킬 사용 후 스킬 적중 시 추가 투사체                                            │
// │ 4. UniTask - 비동기 초기화 및 VFX 정리                                                               │
// └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
//
// ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
// │ 설계 철학 (Design Philosophy)                                                                        │
// │                                                                                                       │
// │ Q: 왜 투사체가 별도 오브젝트인가요?                                                                  │
// │ A: 투사체는 독립적인 생명주기를 가짐.                                                                 │
// │    - 캐릭터와 별개로 이동                                                                            │
// │    - 여러 투사체 동시 존재 가능                                                                       │
// │    - 적중/시간초과 시 개별 소멸                                                                       │
// │    NetworkBehaviour로 서버/클라이언트 동기화 필요.                                                    │
// │                                                                                                       │
// │ Q: 왜 TickTimer를 사용하나요?                                                                        │
// │ A: 일반 Timer는 서버/클라이언트 시간 차이로 동기화 문제 발생.                                          │
// │    TickTimer는 네트워크 틱 기준이라 정확히 동기화됨.                                                   │
// │    5초 후 소멸이 모든 클라이언트에서 동시에 발생.                                                     │
// │                                                                                                       │
// │ Q: 왜 OnTriggerEnter에서 HasStateAuthority 체크?                                                      │
// │ A: 충돌 감지는 모든 클라이언트에서 발생하지만,                                                        │
// │    데미지 처리는 서버에서만 해야 함 (권한 모델).                                                      │
// │    클라이언트에서 처리하면 치트 가능 + 중복 데미지 발생.                                              │
// └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
//
// ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
// │ 투사체 생명주기 (Projectile Lifecycle)                                                               │
// │                                                                                                       │
// │ [스폰]                                                                                                │
// │ 1. Eva_Skill.Skill_Q()에서 Runner.Spawn(qProjectile, ...)                                            │
// │ 2. Spawned() 호출 → TickTimer 5초 설정                                                               │
// │ 3. Init() 호출 → owner, ownerSkill 설정                                                              │
// │ 4. ActiveInit() 호출 → 100ms 후 파티클/콜라이더 활성화                                               │
// │                                                                                                       │
// │ [이동]                                                                                                │
// │ 5. FixedUpdateNetwork() 매 틱 → transform.position += forward * 15 * deltaTime                       │
// │                                                                                                       │
// │ [적중]                                                                                                │
// │ 6a. OnTriggerEnter() → 데미지 10, VFLight 연계, HitVFX 스폰                                          │
// │                                                                                                       │
// │ [소멸]                                                                                                │
// │ 6b. 5초 후 life.Expired() → Runner.Despawn()                                                         │
// └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
//
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════

using System;
using Character.Player;
using Cysharp.Threading.Tasks;
using Fusion;
using UnityEngine;

// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// Eva_Q 클래스 - Q 스킬 투사체
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
//
// 역할:
// - 직선으로 이동하는 투사체
// - 적 적중 시 데미지 + VFLight 연계
// - 5초 후 자동 소멸
//
// 스탯:
// - 데미지: 10
// - 속도: 15 유닛/초
// - 생존 시간: 5초
//
// 관련 파일:
// - Eva_Skill.cs: 이 투사체를 스폰
// - Eva_VFLight.cs: E 스킬 연계 투사체
//
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
public class Eva_Q : NetworkBehaviour
{
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // [Networked] 변수
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // life (TickTimer):
    // - 투사체 생존 시간 타이머
    // - 네트워크 동기화되어 모든 클라이언트에서 동시 소멸
    // - Spawned()에서 5초로 설정
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    [Networked] private TickTimer life { get; set; }

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // 참조 변수
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // owner:
    // - 이 투사체를 발사한 플레이어
    // - 자기 자신 피격 방지에 사용
    //
    // ownerSkill:
    // - Eva_Skill 컴포넌트 참조
    // - TryApplyVFLight() 호출용 (E 스킬 연계)
    //
    // HitVFX:
    // - 적중 시 스폰할 이펙트 프리팹
    // - Inspector에서 할당
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    private PlayerRef owner;
    private Eva_Skill ownerSkill;
    [SerializeField] private GameObject HitVFX;

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // Init() - 초기화 (스폰 후 호출)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // 호출 시점:
    // - Eva_Skill.Skill_Q()에서 Runner.Spawn() 직후 호출
    //
    // 파라미터:
    // - player: 투사체 발사 주인
    // - skill: Eva_Skill 참조 (VFLight 연계용)
    //
    // 왜 Spawned()에서 안 하나요?
    // - Spawned()는 파라미터 전달 불가
    // - owner 정보는 스폰 시점에 외부에서 주입해야 함
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    public void Init(PlayerRef player, Eva_Skill skill = null)
    {
        owner = player;
        ownerSkill = skill;
    }

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // Spawned() - 네트워크 오브젝트 생성 시
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // TickTimer.CreateFromSeconds(Runner, 5.0f):
    // - 5초짜리 타이머 생성
    // - Runner의 네트워크 틱 기준으로 계산
    // - life.Expired(Runner)로 만료 체크
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    public override void Spawned()
    {
        life = TickTimer.CreateFromSeconds(Runner, 5.0f);
    }

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // ActiveInit() - 비동기 활성화 (100ms 딜레이)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // 왜 딜레이가 있나요?
    // - 스폰 직후 콜라이더 활성화하면 캐릭터 자신과 충돌 가능
    // - 100ms 딜레이로 캐릭터에서 충분히 멀어진 후 활성화
    //
    // 활성화 순서:
    // 1. 100ms 대기
    // 2. 파티클 시스템 재생 (시각 효과)
    // 3. SphereCollider 활성화 (충돌 감지 시작)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    public async UniTaskVoid ActiveInit()
    {
        await UniTask.Delay(100);

        var ps = GetComponentInChildren<ParticleSystem>();
        ps.Play();

        var sc = GetComponent<SphereCollider>();
        sc.enabled = true;
    }

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // FixedUpdateNetwork() - 매 네트워크 틱 실행
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // 소멸 체크:
    // - life.Expired(Runner): 5초 경과 여부
    // - 경과했으면 Runner.Despawn()으로 네트워크 오브젝트 제거
    //
    // 이동:
    // - 속도: 15 유닛/초
    // - 방향: transform.forward (스폰 시 설정된 방향)
    // - Runner.DeltaTime: 네트워크 틱 간격
    //
    // 왜 Update()가 아닌 FixedUpdateNetwork()?
    // - 네트워크 동기화된 이동은 FixedUpdateNetwork()에서 해야 함
    // - 모든 클라이언트에서 같은 틱에 같은 위치
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    public override void FixedUpdateNetwork()
    {
        // 생존 시간 체크
        if (life.Expired(Runner))
            Runner.Despawn(Object);
        else
            // 직선 이동: 초당 15 유닛
            transform.position += 15 * transform.forward * Runner.DeltaTime;
    }

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // OnTriggerEnter() - 충돌 감지 (트리거 진입)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // 서버 권한 체크:
    // - 데미지 처리는 서버에서만 (HasStateAuthority)
    // - 클라이언트에서 처리하면 치트/중복 문제
    //
    // 자기 자신 체크:
    // - other.InputAuthority == owner면 자기 자신
    // - 자기 스킬에 맞으면 안 됨
    //
    // 데미지 처리:
    // - IDamageProcess 인터페이스로 타입 무관 데미지
    // - HP > 0 체크로 이미 죽은 적 제외
    //
    // VFLight 연계:
    // - ownerSkill.TryApplyVFLight(targetNO)
    // - E 스킬 사용 후 3초 내면 추가 투사체 발사
    //
    // HitVFX 스폰:
    // - 적중 위치에 이펙트 스폰
    // - 1초 후 자동 제거
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    private void OnTriggerEnter(Collider other)
    {
        // 서버에서만 데미지 처리
        if (!HasStateAuthority) return;

        // 네트워크 오브젝트 체크
        if (other.GetComponentInParent<NetworkObject>() == null) return;

        // 자기 자신이 맞았다면 무시
        if (other.GetComponentInParent<NetworkObject>().InputAuthority == owner)
        {
            return;
        }

        // 데미지 처리
        IDamageProcess damageProcess = other.GetComponent<IDamageProcess>();
        var targetNO = other.GetComponentInParent<NetworkObject>();

        if (damageProcess != null && other.GetComponent<HeroState>().GetCurrHealth() > 0f)
        {
            // 10 데미지
            damageProcess.OnTakeDamage(10);

            // VF 라이트 투사체 발사 (E 스킬 사용 후 3초 내)
            if (ownerSkill != null && targetNO != null)
            {
                ownerSkill.TryApplyVFLight(targetNO);
            }

            // 히트 이펙트 스폰 (서버에서만)
            if (Runner.IsServer)
            {
                var no = Runner.Spawn(HitVFX, other.transform.position + new Vector3(0, 1, 0), Quaternion.identity);
                HitVFXDestroy(no).Forget();
            }
        }
    }

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // HitVFXDestroy() - 히트 이펙트 자동 제거
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // UniTaskVoid + .Forget():
    // - Fire and forget 패턴
    // - 완료를 기다리지 않고 실행
    //
    // 1초 후 Despawn:
    // - 이펙트 재생 시간 동안 유지
    // - 서버에서만 Despawn (네트워크 오브젝트)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    public async UniTaskVoid HitVFXDestroy(NetworkObject no)
    {
        await UniTask.Delay(1000);

        if (Runner.IsServer)
        {
            Runner.Despawn(no);
        }
    }
}
