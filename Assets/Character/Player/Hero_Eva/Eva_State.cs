// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// Eva_State.cs - Eva 캐릭터의 상태 관리 (HP, 사망 처리)
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
//
// ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
// │ 개요 (Overview)                                                                                      │
// │                                                                                                       │
// │ 이 파일은 Eva 캐릭터의 HP와 사망 처리를 담당합니다.                                                   │
// │ IDamageProcess 인터페이스를 구현하여 데미지를 받을 수 있게 합니다.                                    │
// │                                                                                                       │
// │ 핵심 기술:                                                                                            │
// │ 1. IDamageProcess 인터페이스 - 데미지 처리 표준화                                                    │
// │ 2. HeroState 상속 - 기본 상태 변수 (CurrHealth 등)                                                   │
// │ 3. 사망 처리 - NavMeshAgent 정지, 애니메이션 재생                                                    │
// └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
//
// ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
// │ 설계 철학 (Design Philosophy)                                                                        │
// │                                                                                                       │
// │ Q: 왜 IDamageProcess 인터페이스를 사용하나요?                                                        │
// │ A: 다양한 대상(캐릭터, 미니언, 타워 등)이 데미지를 받을 수 있어야 함.                                │
// │    인터페이스로 통일하면 스킬 코드에서 타입 체크 없이 데미지 적용 가능.                               │
// │    예: damageProcess.OnTakeDamage(damage) → 대상이 뭐든 동작                                         │
// │                                                                                                       │
// │ Q: 왜 HeroState를 상속하나요?                                                                        │
// │ A: 모든 영웅 공통 상태(HP, 레벨, 스탯 등)는 HeroState에 정의.                                        │
// │    Eva_State는 Eva 전용 기능만 추가. (현재는 기본 구현만)                                             │
// │                                                                                                       │
// │ Q: 왜 사망 처리가 여기서 이루어지나요?                                                               │
// │ A: HP가 0 이하가 되는 시점은 OnTakeDamage() 호출 시.                                                  │
// │    이 시점에서 바로 사망 처리하는 게 가장 자연스러움.                                                 │
// │    별도의 Update()에서 체크하면 1프레임 딜레이 발생.                                                  │
// └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
//
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════

using Character.Player;
using Fusion;
using UnityEngine;
using UnityEngine.AI;

// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// Eva_State 클래스
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
//
// 상속: HeroState
// - CurrHealth, MaxHealth 등 기본 상태 변수
// - GetCurrHealth(), SetCurrHealth() 등 헬퍼 메서드
//
// 구현: IDamageProcess
// - OnTakeDamage(float damage) 메서드 구현 필수
// - 모든 데미지 소스가 이 인터페이스로 데미지 적용
//
// 사용 예:
// var damageProcess = target.GetComponentInChildren<IDamageProcess>();
// damageProcess?.OnTakeDamage(10f);  // 10 데미지 적용
//
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
public class Eva_State : HeroState, IDamageProcess
{
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // OnTakeDamage() - 데미지 받기 (IDamageProcess 구현)
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // 호출 시점:
    // - 기본 공격 적중
    // - 스킬 적중 (Eva_Q, Eva_W, Eva_R, Eva_VFLight 등)
    //
    // 처리 순서:
    // 1. HP 감소
    // 2. HP <= 0 이면 사망 처리
    //
    // 주의:
    // - 서버에서만 호출되어야 함 (클라이언트에서 호출하면 동기화 문제)
    // - HeroState.CurrHealth는 [Networked] 변수라 자동 동기화됨
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    public void OnTakeDamage(float damage)
    {
        // ═══════════════════════════════════════════════════════════════
        // HP 감소
        //
        // CurrHealth: HeroState에서 상속받은 [Networked] 변수
        // - 서버에서 변경 → 자동으로 모든 클라이언트에 동기화
        // - UI에서 바로 반영됨
        // ═══════════════════════════════════════════════════════════════
        CurrHealth -= damage;

        // ═══════════════════════════════════════════════════════════════
        // 사망 처리
        //
        // HP가 0 이하면:
        // 1. NavMeshAgent 정지 (AI 이동 중지)
        // 2. IsDeath 플래그 설정 (이동 불가)
        // 3. 사망 애니메이션 재생
        // ═══════════════════════════════════════════════════════════════
        if (CurrHealth <= 0)
        {
            // ═══════════════════════════════════════════════════════════
            // NavMeshAgent 정지
            //
            // NavMeshAgent: Unity의 AI 경로 탐색 시스템
            // - isStopped = true: 이동 즉시 중지
            // - 없으면 사망 후에도 이동 시도할 수 있음
            // ═══════════════════════════════════════════════════════════
            var navMeshAgent = GetComponent<NavMeshAgent>();
            navMeshAgent.isStopped = true;

            // ═══════════════════════════════════════════════════════════
            // 사망 플래그 설정
            //
            // IsDeath: HeroMovement에서 관리하는 플래그
            // - true면 모든 이동/스킬 입력 무시
            // - [Networked]라 모든 클라이언트에 동기화됨
            // ═══════════════════════════════════════════════════════════
            var heroMovement = GetComponent<HeroMovement>();
            heroMovement.IsDeath = true;

            // ═══════════════════════════════════════════════════════════
            // 사망 애니메이션
            //
            // RPC_DeadProcess():
            // - 서버에서 호출 → 모든 클라이언트에서 사망 애니메이션 재생
            // - RPC라 동기화 보장
            // ═══════════════════════════════════════════════════════════
            GetComponent<Eva_AnimationController>().RPC_DeadProcess();
        }
    }
}
