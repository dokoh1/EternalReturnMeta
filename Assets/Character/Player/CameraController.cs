// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// CameraController.cs - MOBA 스타일 카메라 제어
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
//
// ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
// │ 개요 (Overview)                                                                                      │
// │                                                                                                       │
// │ 이 파일은 MOBA 게임의 표준 카메라 시스템을 구현합니다.                                                │
// │ 화면 가장자리로 마우스를 이동하면 카메라가 해당 방향으로 이동합니다.                                  │
// │ Y키로 캐릭터에 카메라 고정, Space키로 일시적으로 캐릭터 위치로 이동합니다.                           │
// │                                                                                                       │
// │ 핵심 기술:                                                                                            │
// │ 1. Cinemachine - Unity의 카메라 시스템 (부드러운 추적)                                               │
// │ 2. Screen Edge Scrolling - 화면 가장자리 마우스로 스크롤                                             │
// │ 3. Camera Lock Toggle - Y키로 캐릭터 고정/해제                                                       │
// │ 4. Quick Center - Space키로 즉시 캐릭터 위치로                                                       │
// └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
//
// ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
// │ 설계 철학 (Design Philosophy)                                                                        │
// │                                                                                                       │
// │ Q: 왜 Cinemachine을 사용하나요?                                                                      │
// │ A: Unity 기본 카메라보다 부드러운 추적, 블렌딩 제공.                                                  │
// │    카메라 전환, 흔들림 효과 등 추가 기능 쉽게 구현 가능.                                              │
// │    LOL, 발로란트 등 현대 게임에서 표준으로 사용.                                                      │
// │                                                                                                       │
// │ Q: 왜 화면 가장자리 스크롤인가요?                                                                    │
// │ A: MOBA 게임의 표준 UX.                                                                               │
// │    - WASD: 이미 스킬에 사용                                                                           │
// │    - 드래그: 클릭과 충돌                                                                              │
// │    - 화면 가장자리: 직관적, 손이 자유로움                                                            │
// │                                                                                                       │
// │ Q: Y키와 Space키의 차이는?                                                                           │
// │ A: Y키: 토글 (켜면 계속 고정)                                                                         │
// │    Space키: 누르는 동안만 고정 (손 떼면 해제)                                                         │
// │    상황에 따라 다르게 사용 (스킬 시전 vs 맵 확인)                                                     │
// │                                                                                                       │
// │ Q: ScreenEdgeThreshold가 10인 이유는?                                                                │
// │ A: 너무 작으면 감지 어려움, 너무 크면 의도치 않은 스크롤.                                             │
// │    10픽셀은 경험적으로 적절한 값.                                                                    │
// │    설정에서 조절 가능하게 할 수 있음.                                                                 │
// └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
//
// ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
// │ 조작법 (Controls)                                                                                    │
// │                                                                                                       │
// │ 화면 가장자리 마우스: 카메라 해당 방향으로 이동                                                       │
// │ Y 키:                카메라 고정 토글 (캐릭터에 잠금)                                                 │
// │ Space 키:            누르는 동안 캐릭터 위치로 이동                                                   │
// │                                                                                                       │
// │ ┌──────────────────────────────────┐                                                                  │
// │ │          ↑ 위로 스크롤           │                                                                  │
// │ │  ← │                        │ → │                                                                  │
// │ │ 왼 │       게임 화면        │오른│                                                                  │
// │ │ 쪽 │                        │ 쪽 │                                                                  │
// │ │    │                        │    │                                                                  │
// │ │          ↓ 아래로 스크롤         │                                                                  │
// │ └──────────────────────────────────┘                                                                  │
// │     10px       화면 중앙       10px                                                                   │
// └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
//
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════

using System;
using Fusion;
using Unity.Cinemachine;
using UnityEngine;

// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// CameraController 클래스
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
//
// 역할:
// - 화면 가장자리 스크롤로 카메라 이동
// - Y키로 캐릭터에 카메라 고정 토글
// - Space키로 일시적 캐릭터 추적
//
// 컴포넌트 위치:
// - 플레이어 캐릭터에 부착
// - HasInputAuthority로 로컬 플레이어만 동작
//
// 관련 파일:
// - HeroCameraPoint.cs: 카메라가 추적할 포인트
// - MouseController.cs: 커서 화면 내 잠금 (스크롤 전제조건)
//
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
public class CameraController : NetworkBehaviour
{
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // 컴포넌트 참조
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // _CinemachineCamera:
    // - Cinemachine 가상 카메라
    // - Spawned()에서 태그로 찾아 할당
    // - TrackingTarget으로 추적 대상 설정
    //
    // CameraPoint:
    // - 카메라가 추적할 포인트 (캐릭터 위)
    // - HeroCameraPoint 컴포넌트 부착된 오브젝트
    // - Inspector에서 할당
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    public CinemachineCamera _CinemachineCamera;
    public Transform CameraPoint;

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // 카메라 설정 값
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // CameraMoveSpeed:
    // - 화면 가장자리 스크롤 속도
    // - 높을수록 빠르게 이동
    // - 25는 적절한 기본값
    //
    // ScreenEdgeThreshold:
    // - 화면 가장자리 감지 범위 (픽셀)
    // - 마우스가 이 범위 안에 들어오면 스크롤 시작
    // - 10픽셀 = 화면 가장자리 10픽셀 영역
    //
    // isCameraLocked:
    // - Y키 토글 상태
    // - true: 캐릭터에 고정
    // - false: 자유 이동 가능
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    public float CameraMoveSpeed = 25f;
    public float ScreenEdgeThreshold = 10f;

    private bool isCameraLocked = false;

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // Spawned() - 네트워크 오브젝트 생성 시 초기화
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // 왜 Spawned()에서 카메라를 찾나요?
    // - 카메라는 씬에 하나만 존재 (공유 자원)
    // - 플레이어 프리팹에 포함 불가
    // - 런타임에 태그로 찾아야 함
    //
    // FindWithTag("CinemachineCamera"):
    // - 씬에서 "CinemachineCamera" 태그를 가진 오브젝트 찾기
    // - 여러 플레이어가 있어도 같은 카메라 공유
    // - HasInputAuthority 체크로 로컬 플레이어만 카메라 사용
    //
    // 초기 위치 설정:
    // - 카메라를 CameraPoint 위치로 이동
    // - 게임 시작 시 캐릭터가 화면 중앙에 오도록
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    public override void Spawned()
    {
        if (HasInputAuthority)
        {
            GameObject obj = GameObject.FindWithTag("CinemachineCamera");
            _CinemachineCamera = obj.GetComponent<CinemachineCamera>();
            _CinemachineCamera.transform.position = CameraPoint.transform.position;
        }
    }

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // Update() - 매 프레임 카메라 제어
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    private void Update()
    {
        // 로컬 플레이어만 카메라 제어
        if (!HasInputAuthority) return;

        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        // Y키: 카메라 고정 토글
        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        //
        // isCameraLocked = true:
        // - TrackingTarget 설정 → 카메라가 CameraPoint 자동 추적
        // - 화면 가장자리 스크롤 비활성화
        //
        // isCameraLocked = false:
        // - TrackingTarget = null → 자동 추적 해제
        // - 화면 가장자리 스크롤 활성화
        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        if (Input.GetKeyDown(KeyCode.Y))
        {
            isCameraLocked = !isCameraLocked;

            if (isCameraLocked)
            {
                _CinemachineCamera.Target.TrackingTarget = CameraPoint.transform;
            }
            else
            {
                _CinemachineCamera.Target.TrackingTarget = null;
            }
        }

        // 카메라 고정 중이면 가장자리 이동 비활성화
        if (!isCameraLocked)
        {
            CameraMoveToScreenEdge();
        }

        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        // Space키: 일시적 캐릭터 추적
        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        //
        // GetKey (누르고 있는 동안):
        // - 카메라를 캐릭터 위치로 즉시 이동
        // - TrackingTarget 설정 (Y키로 이미 고정된 경우 제외)
        //
        // GetKeyUp (손 뗄 때):
        // - Y키로 고정된 상태가 아니면 TrackingTarget 해제
        // - 카메라가 현재 위치에 머무름
        //
        // 사용 시나리오:
        // - 맵 구석 확인 후 빠르게 캐릭터로 복귀
        // - 팀파이트 중 캐릭터 위치 확인
        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        if (Input.GetKey(KeyCode.Space))
        {
            _CinemachineCamera.transform.position = CameraPoint.transform.position;
            if (_CinemachineCamera.Target.TrackingTarget == null && !isCameraLocked)
            {
                _CinemachineCamera.Target.TrackingTarget = CameraPoint.transform;
            }
        }
        if (Input.GetKeyUp(KeyCode.Space) && !isCameraLocked)
        {
            _CinemachineCamera.Target.TrackingTarget = null;
        }
    }

    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    // CameraMoveToScreenEdge() - 화면 가장자리 스크롤
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    //
    // 동작 원리:
    // 1. 마우스 위치 확인
    // 2. 화면 가장자리 (10픽셀 이내) 인지 체크
    // 3. 해당 방향으로 카메라 이동
    //
    // 좌표계:
    // - 화면 좌표: (0,0) = 좌하단, (width, height) = 우상단
    // - 카메라 이동: X = 좌우, Z = 앞뒤 (위에서 내려다보는 시점)
    // - Y는 고정 (높이 변경 없음)
    //
    // 정규화 (normalized):
    // - 대각선 이동 시 속도 일정하게 유지
    // - (1,0,1) 방향 = √2 속도 → (0.7,0,0.7) 방향 = 1 속도
    // ═══════════════════════════════════════════════════════════════════════════════════════════════════
    private void CameraMoveToScreenEdge()
    {
        Vector3 mousePosition = Input.mousePosition;

        // 화면 너비와 높이
        float screenWidth = Screen.width;
        float screenHeight = Screen.height;

        // 카메라 이동 벡터 초기화
        Vector3 cameraMoveDirection = Vector3.zero;

        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        // 좌우 이동 감지
        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        //
        // 왼쪽 가장자리 (0 ~ 10픽셀):
        // - mousePosition.x <= 10
        // - 카메라를 왼쪽으로 (X = -1)
        //
        // 오른쪽 가장자리 (width-10 ~ width 픽셀):
        // - mousePosition.x >= width - 10
        // - 카메라를 오른쪽으로 (X = +1)
        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        if (mousePosition.x <= ScreenEdgeThreshold)
        {
            cameraMoveDirection.x = -1;
        }
        else if (mousePosition.x >= screenWidth - ScreenEdgeThreshold)
        {
            cameraMoveDirection.x = 1;
        }

        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        // 상하 이동 감지 (Z축 = 앞뒤)
        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        //
        // 아래 가장자리 (0 ~ 10픽셀):
        // - 화면 아래 = 게임 세계에서 뒤로 (Z = -1)
        //
        // 위 가장자리 (height-10 ~ height 픽셀):
        // - 화면 위 = 게임 세계에서 앞으로 (Z = +1)
        //
        // 주의: 카메라 각도에 따라 방향 조정 필요할 수 있음
        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        if (mousePosition.y <= ScreenEdgeThreshold)
        {
            cameraMoveDirection.z = -1;
        }
        else if (mousePosition.y >= screenHeight - ScreenEdgeThreshold)
        {
            cameraMoveDirection.z = 1;
        }

        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        // 카메라 이동 적용
        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        //
        // cameraMoveDirection != Vector3.zero:
        // - 가장자리에 마우스가 있을 때만 이동
        //
        // .normalized * speed * deltaTime:
        // - normalized: 대각선도 같은 속도
        // - speed: 초당 이동 거리
        // - deltaTime: 프레임 독립적 이동
        //
        // Translate(vector, Space.World):
        // - 월드 좌표계 기준 이동
        // - 카메라 회전과 무관하게 X/Z 축 이동
        // ═══════════════════════════════════════════════════════════════════════════════════════════════
        if (cameraMoveDirection != Vector3.zero)
        {
            Vector3 moveVector = cameraMoveDirection.normalized * (CameraMoveSpeed * Time.deltaTime);
            _CinemachineCamera.transform.Translate(moveVector, Space.World);
        }
    }
}
